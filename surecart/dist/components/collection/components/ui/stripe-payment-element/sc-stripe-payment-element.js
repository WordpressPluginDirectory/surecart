import{h}from"@stencil/core";import{loadStripe}from"@stripe/stripe-js/pure";import{__}from"@wordpress/i18n";import{addQueryArgs}from"@wordpress/url";import{state as selectedProcessor}from"../../../store/selected-processor/index";import{state as checkoutState,onChange}from"../../../store/checkout/index";import{onChange as onChangeFormState}from"../../../store/form/index";import{state as processorsState}from"../../../store/processors/index";import{currentFormState}from"../../../store/form/getters";import{createErrorNotice}from"../../../store/notices/mutations";import{updateFormState}from"../../../store/form/mutations";import{getCompleteAddress}from"../../../store/checkout/getters";import{getProcessorByType}from"../../../store/processors/getters";export class ScStripePaymentElement{constructor(){this.error=void 0,this.confirming=!1,this.isInitializingStripe=!1,this.isCreatingUpdatingStripeElement=!1,this.loaded=!1,this.styles=void 0}async componentWillLoad(){this.fetchStyles(),this.syncCheckoutMode()}async handleStylesChange(){this.createOrUpdateElements()}async fetchStyles(){this.styles=await this.getComputedStyles()}getComputedStyles(){return new Promise((e=>{let t=setInterval((()=>{const o=window.getComputedStyle(document.body);o.getPropertyValue("--sc-color-primary-500")&&(clearInterval(t),e(o))}),100)}))}async syncCheckoutMode(){onChange("checkout",(()=>{this.initializeStripe()}))}async componentDidLoad(){this.initializeStripe()}async initializeStripe(){var e,t;if(void 0===(null===(e=null==checkoutState?void 0:checkoutState.checkout)||void 0===e?void 0:e.live_mode)||(null===(t=null==processorsState?void 0:processorsState.instances)||void 0===t?void 0:t.stripe)||this.isInitializingStripe)return;this.isInitializingStripe=!0;const{processor_data:o}=getProcessorByType("stripe")||{};try{processorsState.instances.stripe=await loadStripe(null==o?void 0:o.publishable_key,{stripeAccount:null==o?void 0:o.account_id}),this.error=""}catch(e){return this.error=(null==e?void 0:e.message)||__("Stripe could not be loaded","surecart"),void(this.isInitializingStripe=!1)}this.createOrUpdateElements(),this.handleUpdateElement(),this.unlistenToCheckout=onChange("checkout",(()=>{this.fetchStyles(),this.createOrUpdateElements(),this.handleUpdateElement()})),this.unlistenToFormState=onChangeFormState("formState",(()=>{var e;(null===(e=null==checkoutState?void 0:checkoutState.checkout)||void 0===e?void 0:e.payment_method_required)&&"paying"===currentFormState()&&this.maybeConfirmOrder()})),this.isInitializingStripe=!1}clearStripeInstances(){var e,t,o,i;if(this.isInitializingStripe=!1,this.isCreatingUpdatingStripeElement=!1,null==this?void 0:this.element){try{null===(t=null===(e=this.element)||void 0===e?void 0:e.unmount)||void 0===t||t.call(e)}catch(e){console.warn("Could not unmount Stripe element:",e)}this.element=null}(null===(o=null==processorsState?void 0:processorsState.instances)||void 0===o?void 0:o.stripeElements)&&(processorsState.instances.stripeElements=null),(null===(i=null==processorsState?void 0:processorsState.instances)||void 0===i?void 0:i.stripe)&&(processorsState.instances.stripe=null)}disconnectedCallback(){this.unlistenToFormState(),this.unlistenToCheckout(),this.clearStripeInstances()}getElementsConfig(){var e,t,o,i;const s=getComputedStyle(this.el);return{mode:(null===(e=checkoutState.checkout)||void 0===e?void 0:e.remaining_amount_due)>0?"payment":"setup",amount:null===(t=checkoutState.checkout)||void 0===t?void 0:t.remaining_amount_due,currency:null===(o=checkoutState.checkout)||void 0===o?void 0:o.currency,setupFutureUsage:(null===(i=checkoutState.checkout)||void 0===i?void 0:i.reusable_payment_method_required)?"off_session":null,appearance:{variables:{colorPrimary:s.getPropertyValue("--sc-color-primary-500")||"black",colorText:s.getPropertyValue("--sc-input-label-color")||"black",borderRadius:s.getPropertyValue("--sc-input-border-radius-medium")||"4px",colorBackground:s.getPropertyValue("--sc-input-background-color")||"white",fontSizeBase:s.getPropertyValue("--sc-input-font-size-medium")||"16px",colorLogo:s.getPropertyValue("--sc-stripe-color-logo")||"light",colorLogoTab:s.getPropertyValue("--sc-stripe-color-logo-tab")||"light",colorLogoTabSelected:s.getPropertyValue("--sc-stripe-color-logo-tab-selected")||"light",colorTextPlaceholder:s.getPropertyValue("--sc-input-placeholder-color")||"black"},rules:{".Input":{border:s.getPropertyValue("--sc-input-border")}}}}}maybeApplyFilters(e){var t,o,i;return(null===(o=null===(t=null===window||void 0===window?void 0:window.wp)||void 0===t?void 0:t.hooks)||void 0===o?void 0:o.applyFilters)?{...e,paymentMethodOrder:window.wp.hooks.applyFilters("surecart_stripe_payment_element_payment_method_order",[],checkoutState.checkout),wallets:window.wp.hooks.applyFilters("surecart_stripe_payment_element_wallets",{},checkoutState.checkout),terms:window.wp.hooks.applyFilters("surecart_stripe_payment_element_terms",{},checkoutState.checkout),fields:window.wp.hooks.applyFilters("surecart_stripe_payment_element_fields",null!==(i=e.fields)&&void 0!==i?i:{})}:e}createOrUpdateElements(){var e,t,o,i,s,r;if((null===(e=null==checkoutState?void 0:checkoutState.checkout)||void 0===e?void 0:e.payment_method_required)&&processorsState.instances.stripe&&!this.isCreatingUpdatingStripeElement&&(!(null===(t=checkoutState.checkout)||void 0===t?void 0:t.status)||!["paid","processing"].includes(null===(o=checkoutState.checkout)||void 0===o?void 0:o.status))){if(this.isCreatingUpdatingStripeElement=!0,!processorsState.instances.stripeElements){processorsState.instances.stripeElements=processorsState.instances.stripe.elements(this.getElementsConfig());const{line1:e,line2:t,city:o,state:a,country:n,postal_code:c}=null!==(i=getCompleteAddress("shipping"))&&void 0!==i?i:{},l=this.maybeApplyFilters({defaultValues:{billingDetails:{name:null===(s=checkoutState.checkout)||void 0===s?void 0:s.name,email:null===(r=checkoutState.checkout)||void 0===r?void 0:r.email,...e&&{address:{line1:e,line2:t,city:o,state:a,country:n,postal_code:c}}}},fields:{billingDetails:{email:"never"}}});return processorsState.instances.stripeElements.create("payment",l).mount(this.container),this.element=processorsState.instances.stripeElements.getElement("payment"),this.element.on("ready",(()=>this.loaded=!0)),this.element.on("change",(e=>{var t,o,i,s,r,a,n;checkoutState.paymentMethodRequiresShipping=["cashapp","klarna","clearpay"].includes(null===(t=null==e?void 0:e.value)||void 0===t?void 0:t.type),e.complete&&this.scPaymentInfoAdded.emit({checkout_id:null===(o=checkoutState.checkout)||void 0===o?void 0:o.id,currency:null===(i=checkoutState.checkout)||void 0===i?void 0:i.currency,processor_type:"stripe",total_amount:null===(s=checkoutState.checkout)||void 0===s?void 0:s.total_amount,line_items:null===(r=checkoutState.checkout)||void 0===r?void 0:r.line_items,payment_method:{billing_details:{email:null===(a=checkoutState.checkout)||void 0===a?void 0:a.email,name:null===(n=checkoutState.checkout)||void 0===n?void 0:n.name}}})})),void(this.isCreatingUpdatingStripeElement=!1)}processorsState.instances.stripeElements.update(this.getElementsConfig()),this.isCreatingUpdatingStripeElement=!1}}handleUpdateElement(){var e,t;if(!this.element)return;if("draft"!==(null===(e=checkoutState.checkout)||void 0===e?void 0:e.status))return;const{name:o,email:i}=checkoutState.checkout,{line_1:s,line_2:r,city:a,state:n,country:c,postal_code:l}=(null===(t=checkoutState.checkout)||void 0===t?void 0:t.shipping_address)||{},d=this.maybeApplyFilters({defaultValues:{billingDetails:{name:o,email:i,address:{line1:s,line2:r,city:a,state:n,country:c,postal_code:l}}},fields:{billingDetails:{email:"never"}}});this.element.update(d)}async submit(){if("stripe"!==(null==selectedProcessor?void 0:selectedProcessor.id))return;const{error:e}=await processorsState.instances.stripeElements.submit();return e?(console.error({error:e}),updateFormState("REJECT"),createErrorNotice(e),void(this.error=e.message)):void 0}async maybeConfirmOrder(){var e,t,o,i,s,r,a,n,c,l,d,u,p,m;if("stripe"===(null==selectedProcessor?void 0:selectedProcessor.id)&&"stripe"===(null===(t=null===(e=checkoutState.checkout)||void 0===e?void 0:e.payment_intent)||void 0===t?void 0:t.processor_type)&&(null===(r=null===(s=null===(i=null===(o=checkoutState.checkout)||void 0===o?void 0:o.payment_intent)||void 0===i?void 0:i.processor_data)||void 0===s?void 0:s.stripe)||void 0===r?void 0:r.type)&&(null===(l=null===(c=null===(n=null===(a=checkoutState.checkout)||void 0===a?void 0:a.payment_intent)||void 0===n?void 0:n.processor_data)||void 0===c?void 0:c.stripe)||void 0===l?void 0:l.client_secret))return await this.confirm(null===(m=null===(p=null===(u=null===(d=checkoutState.checkout)||void 0===d?void 0:d.payment_intent)||void 0===u?void 0:u.processor_data)||void 0===p?void 0:p.stripe)||void 0===m?void 0:m.type)}async confirm(e,t={}){var o,i,s,r;const a={elements:processorsState.instances.stripeElements,clientSecret:null===(r=null===(s=null===(i=null===(o=checkoutState.checkout)||void 0===o?void 0:o.payment_intent)||void 0===i?void 0:i.processor_data)||void 0===s?void 0:s.stripe)||void 0===r?void 0:r.client_secret,confirmParams:{return_url:addQueryArgs(window.location.href,{...checkoutState.checkout.id?{checkout_id:checkoutState.checkout.id}:{}}),payment_method_data:{billing_details:{email:checkoutState.checkout.email}}},redirect:"if_required",...t};if(!this.confirming&&processorsState.instances.stripe)try{this.scSetState.emit("PAYING");const t="setup"===e?await processorsState.instances.stripe.confirmSetup(a):await processorsState.instances.stripe.confirmPayment(a);if(null==t?void 0:t.error)throw this.error=t.error.message,t.error;this.scSetState.emit("PAID"),this.scPaid.emit()}catch(e){console.error(e),updateFormState("REJECT"),createErrorNotice(e),e.message&&(this.error=e.message)}finally{this.confirming=!1}}render(){return h("div",{key:"5a429f0e46f4a650d4fceea406e0542b8356c843",class:"sc-stripe-payment-element","data-testid":"stripe-payment-element"},!!this.error&&h("sc-text",{key:"351fb4054788e4213d7743bf067e6213d706a1df",style:{color:"var(--sc-color-danger-500)","--font-size":"var(--sc-font-size-small)",marginBottom:"0.5em"}},this.error),h("div",{key:"5b2e9abf48180e24b6aaec7d35e1440d7a47340c",class:"loader",hidden:this.loaded},h("div",{key:"e09d777c4fc3c110451012a35d474f8b0da9247b",class:"loader__row"},h("div",{key:"0e71dc3b995c86ca0f7fa794ac3a9af47dee7742",style:{width:"50%"}},h("sc-skeleton",{key:"f7b5f6ff304183bc6dd8a893b042653051bf902f",style:{width:"50%",marginBottom:"0.5em"}}),h("sc-skeleton",{key:"883ce3a8c3353a16587def7870d56a6e17fcb296"})),h("div",{key:"79443b0f986dc917affca3de555a42e7e197b5a6",style:{flex:"1"}},h("sc-skeleton",{key:"1c49cc719b3b91968dbbeb847365914eb5607b41",style:{width:"50%",marginBottom:"0.5em"}}),h("sc-skeleton",{key:"9260defe9f3416393307cb48b15853dd519d1419"})),h("div",{key:"8cb9c68432d22304997be5afa726b36d8495fad5",style:{flex:"1"}},h("sc-skeleton",{key:"6a37f1eb19ea8b7b3e59cefb7044c48478426db9",style:{width:"50%",marginBottom:"0.5em"}}),h("sc-skeleton",{key:"458635df9fe13abd81ccdd450bfaf0ebccbc3979"}))),h("div",{key:"4a3690c02ece290a7881c75c180a392b5d2a79ec",class:"loader__details"},h("sc-skeleton",{key:"3c5fb8fc8ec4685b74b67f9572525d64b2060304",style:{height:"1rem"}}),h("sc-skeleton",{key:"1f36b893c77db4abc13162a595ad006515396063",style:{height:"1rem",width:"30%"}}))),h("div",{key:"20ec2c083678bf42b7eff981d0207aa34325c98c",hidden:!this.loaded,class:"sc-payment-element-container",ref:e=>this.container=e}))}static get is(){return"sc-stripe-payment-element"}static get originalStyleUrls(){return{$:["sc-stripe-payment-element.scss"]}}static get styleUrls(){return{$:["sc-stripe-payment-element.css"]}}static get states(){return{error:{},confirming:{},isInitializingStripe:{},isCreatingUpdatingStripeElement:{},loaded:{},styles:{}}}static get events(){return[{method:"scPaid",name:"scPaid",bubbles:!0,cancelable:!0,composed:!0,docs:{tags:[],text:"The order/invoice was paid for."},complexType:{original:"void",resolved:"void",references:{}}},{method:"scSetState",name:"scSetState",bubbles:!0,cancelable:!0,composed:!0,docs:{tags:[],text:"Set the state"},complexType:{original:"FormStateSetter",resolved:'"EXPIRE" | "FETCH" | "FINALIZE" | "PAID" | "PAYING" | "REJECT" | "RESOLVE"',references:{FormStateSetter:{location:"import",path:"../../../types",id:"src/types.ts::FormStateSetter"}}}},{method:"scPaymentInfoAdded",name:"scPaymentInfoAdded",bubbles:!0,cancelable:!0,composed:!0,docs:{tags:[],text:"Payment information was added"},complexType:{original:"PaymentInfoAddedParams",resolved:"PaymentInfoAddedParams",references:{PaymentInfoAddedParams:{location:"import",path:"../../../types",id:"src/types.ts::PaymentInfoAddedParams"}}}}]}static get methods(){return{confirm:{complexType:{signature:"(type: any, args?: {}) => Promise<void>",parameters:[{name:"type",type:"any",docs:""},{name:"args",type:"{}",docs:""}],references:{Promise:{location:"global",id:"global::Promise"}},return:"Promise<void>"},docs:{text:"",tags:[]}}}}static get elementRef(){return"el"}static get watchers(){return[{propName:"styles",methodName:"handleStylesChange"}]}}