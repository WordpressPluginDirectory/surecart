import{__}from"@wordpress/i18n";import{h,Host}from"@stencil/core";import apiFetch from"../../../functions/fetch";import{loadRazorpay}from"../../../functions/razorpay";export class ScRazorpayAddMethod{constructor(){this.razorpayInstance=null,this.confirming=!1,this.liveMode=!0,this.customerId=void 0,this.successUrl=void 0,this.currency=void 0,this.loading=void 0,this.loaded=void 0,this.error=void 0,this.paymentIntent=void 0}async handlePaymentIntentCreate(){if(this.confirming)return;const{external_intent_id:e,processor_data:t}=this.paymentIntent||{},{public_key:r,customer_id:a}=(null==t?void 0:t.razorpay)||{};if(r&&e){this.confirming=!0;try{this.razorpayInstance||(this.razorpayInstance=await loadRazorpay());const t={key:r,order_id:e,customer_id:a,recurring:!0,handler:async e=>{(null==e?void 0:e.razorpay_payment_id)?window.location.assign(this.successUrl):(this.error=__("Payment verification failed. Please contact support.","surecart"),this.loading=!1)},modal:{ondismiss:()=>{this.loading=!1}}},i=new this.razorpayInstance(t);i.on("payment.failed",(e=>{var t;this.error=(null===(t=null==e?void 0:e.error)||void 0===t?void 0:t.description)||__("Payment failed. Please try again.","surecart"),this.loading=!1,console.error("payment.failed",e)})),i.open()}catch(e){this.error=(null==e?void 0:e.message)||__("Something went wrong","surecart"),this.loading=!1,console.error(e)}finally{this.confirming=!1}}}async createPaymentIntent(){var e,t;try{this.loading=!0,this.error="",this.paymentIntent=await apiFetch({method:"POST",path:"surecart/v1/payment_intents",data:{processor_type:"razorpay",reusable:!0,live_mode:this.liveMode,customer_id:this.customerId,currency:this.currency,refresh_status:!0}})}catch(r){console.error(r),this.error=(null===(t=null===(e=null==r?void 0:r.additional_errors)||void 0===e?void 0:e[0])||void 0===t?void 0:t.message)||(null==r?void 0:r.message)||__("Something went wrong","surecart"),this.loading=!1}}render(){return h(Host,{key:"6bcb832576f72b55f6afe82bd5fb58458dc038cf"},this.error&&h("sc-alert",{key:"47ced5d3c826ae061dc20f2887970c8c3390d10e",open:!!this.error,type:"danger"},h("span",{key:"3099705723df5c40f705351a1864044355c69444",slot:"title"},__("Error","surecart")),this.error),h("div",{key:"f3466ae0f222c2880619083c6662ca608deb7090",class:"sc-razorpay-button-container"},h("sc-alert",{key:"85d6d3fbb8260f83c5b345c1c26dc50f14fee3c8",open:!0,type:"warning"},__("In order to add a new card, we will need to make a small transaction to authenticate it. This is for authentication purposes and will be immediately refunded.","surecart"),h("div",{key:"b058c3d0b6eca9ae83a042329241d68cdcd234a5"},h("sc-button",{key:"88b66be329f78e8e1d1547070b6c7484b8cc3ccf",loading:this.loading,type:"primary",onClick:()=>this.createPaymentIntent(),style:{marginTop:"var(--sc-spacing-medium)"}},__("Add New Card","surecart"))))))}static get is(){return"sc-razorpay-add-method"}static get originalStyleUrls(){return{$:["sc-razorpay-add-method.scss"]}}static get styleUrls(){return{$:["sc-razorpay-add-method.css"]}}static get properties(){return{liveMode:{type:"boolean",mutable:!1,complexType:{original:"boolean",resolved:"boolean",references:{}},required:!1,optional:!1,docs:{tags:[],text:""},attribute:"live-mode",reflect:!1,defaultValue:"true"},customerId:{type:"string",mutable:!1,complexType:{original:"string",resolved:"string",references:{}},required:!1,optional:!1,docs:{tags:[],text:""},attribute:"customer-id",reflect:!1},successUrl:{type:"string",mutable:!1,complexType:{original:"string",resolved:"string",references:{}},required:!1,optional:!1,docs:{tags:[],text:""},attribute:"success-url",reflect:!1},currency:{type:"string",mutable:!1,complexType:{original:"string",resolved:"string",references:{}},required:!1,optional:!1,docs:{tags:[],text:""},attribute:"currency",reflect:!1}}}static get states(){return{loading:{},loaded:{},error:{},paymentIntent:{}}}static get watchers(){return[{propName:"paymentIntent",methodName:"handlePaymentIntentCreate"}]}}