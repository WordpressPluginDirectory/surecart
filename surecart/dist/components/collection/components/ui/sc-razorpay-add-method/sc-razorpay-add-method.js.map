{"version":3,"file":"sc-razorpay-add-method.js","sourceRoot":"","sources":["../../../../src/components/ui/sc-razorpay-add-method/sc-razorpay-add-method.tsx"],"names":[],"mappings":"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","sourcesContent":["/**\n * WordPress dependencies.\n */\nimport { __ } from '@wordpress/i18n';\n\n/**\n * External dependencies.\n */\nimport { Component, h, Host, Prop, State, Watch } from '@stencil/core';\n\n/**\n * Internal dependencies.\n */\nimport apiFetch from '../../../functions/fetch';\nimport { loadRazorpay } from 'src/functions/razorpay';\nimport { PaymentIntent, RazorpayConstructor } from 'src/types';\n\n@Component({\n  tag: 'sc-razorpay-add-method',\n  styleUrl: 'sc-razorpay-add-method.scss',\n  shadow: false,\n})\nexport class ScRazorpayAddMethod {\n  @Prop() liveMode: boolean = true;\n  @Prop() customerId: string;\n  @Prop() successUrl: string;\n  @Prop() currency: string;\n\n  @State() loading: boolean;\n  @State() loaded: boolean;\n  @State() error: string;\n  @State() paymentIntent: PaymentIntent;\n\n  private razorpayInstance: RazorpayConstructor | null = null;\n  private confirming: boolean = false;\n\n  @Watch('paymentIntent')\n  async handlePaymentIntentCreate() {\n    // Prevent multiple simultaneous payment attempts\n    if (this.confirming) return;\n\n    const { external_intent_id, processor_data } = this.paymentIntent || {};\n    const { public_key, customer_id } = (processor_data?.razorpay || {}) as any;\n\n    // we need this data.\n    if (!public_key || !external_intent_id) return;\n\n    this.confirming = true;\n\n    try {\n      // Load Razorpay if not loaded yet.\n      if (!this.razorpayInstance) {\n        this.razorpayInstance = await loadRazorpay();\n      }\n\n      const options = {\n        key: public_key,\n        order_id: external_intent_id,\n        customer_id,\n        recurring: true,\n        handler: async (response: any) => {\n          if (response?.razorpay_payment_id) {\n            window.location.assign(this.successUrl);\n          } else {\n            this.error = __('Payment verification failed. Please contact support.', 'surecart');\n            this.loading = false;\n          }\n        },\n        modal: {\n          ondismiss: () => {\n            this.loading = false;\n          },\n        },\n      };\n\n      const razorpay = new this.razorpayInstance(options);\n\n      razorpay.on('payment.failed', response => {\n        this.error = response?.error?.description || __('Payment failed. Please try again.', 'surecart');\n        this.loading = false;\n        console.error('payment.failed', response);\n      });\n\n      razorpay.open();\n    } catch (e) {\n      this.error = e?.message || __('Something went wrong', 'surecart');\n      this.loading = false;\n      console.error(e);\n    } finally {\n      this.confirming = false;\n    }\n  }\n\n  async createPaymentIntent() {\n    try {\n      this.loading = true;\n      this.error = '';\n      this.paymentIntent = await apiFetch({\n        method: 'POST',\n        path: 'surecart/v1/payment_intents',\n        data: {\n          processor_type: 'razorpay',\n          reusable: true,\n          live_mode: this.liveMode,\n          customer_id: this.customerId,\n          currency: this.currency,\n          refresh_status: true,\n        },\n      });\n    } catch (e) {\n      console.error(e);\n      this.error = e?.additional_errors?.[0]?.message || e?.message || __('Something went wrong', 'surecart');\n      this.loading = false;\n    }\n  }\n\n  render() {\n    return (\n      <Host>\n        {this.error && (\n          <sc-alert open={!!this.error} type=\"danger\">\n            <span slot=\"title\">{__('Error', 'surecart')}</span>\n            {this.error}\n          </sc-alert>\n        )}\n        <div class=\"sc-razorpay-button-container\">\n          <sc-alert open={true} type=\"warning\">\n            {__(\n              'In order to add a new card, we will need to make a small transaction to authenticate it. This is for authentication purposes and will be immediately refunded.',\n              'surecart',\n            )}\n            <div>\n              <sc-button loading={this.loading} type=\"primary\" onClick={() => this.createPaymentIntent()} style={{ marginTop: 'var(--sc-spacing-medium)' }}>\n                {__('Add New Card', 'surecart')}\n              </sc-button>\n            </div>\n          </sc-alert>\n        </div>\n      </Host>\n    );\n  }\n}\n"]}