{"version":3,"file":"sc-checkout-razorpay-payment-provider.js","sourceRoot":"","sources":["../../../../../src/components/controllers/checkout-form/sc-checkout-razorpay-payment-provider/sc-checkout-razorpay-payment-provider.tsx"],"names":[],"mappings":"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","sourcesContent":["/**\n * External dependencies.\n */\nimport { __, sprintf } from '@wordpress/i18n';\nimport { Component } from '@stencil/core';\n\n/**\n * Internal dependencies.\n */\nimport { state as checkoutState } from '@store/checkout';\nimport { state as selectedProcessor } from '@store/selected-processor';\nimport { onChange as onChangeFormState } from '@store/form';\nimport { currentFormState } from '@store/form/getters';\nimport { updateFormState } from '@store/form/mutations';\nimport { createErrorNotice } from '@store/notices/mutations';\nimport { loadRazorpay } from 'src/functions/razorpay';\nimport { Customer, RazorpayConstructor } from 'src/types';\n\n@Component({\n  tag: 'sc-checkout-razorpay-payment-provider',\n  shadow: true,\n})\nexport class ScCheckoutRazorpayPaymentProvider {\n  private unlistenToFormState: () => void;\n  private razorpayInstance: RazorpayConstructor | null = null;\n  private confirming: boolean = false;\n\n  componentWillLoad() {\n    // Preload Razorpay script.\n    loadRazorpay()\n      .then(instance => (this.razorpayInstance = instance))\n      .catch(err => createErrorNotice({ message: err.message }));\n\n    // we need to listen to the form state and pay when the form state enters the paying state.\n    this.unlistenToFormState = onChangeFormState('formState', () => {\n      // are we paying?\n      if ('paying' === currentFormState()) {\n        this.confirm();\n      }\n    });\n  }\n\n  disconnectedCallback() {\n    this.unlistenToFormState();\n  }\n\n  async confirm() {\n    // this processor is not selected.\n    if (selectedProcessor?.id !== 'razorpay') return;\n    // Must be a razorpay session\n    if (!checkoutState?.checkout?.payment_intent?.processor_data?.razorpay) return;\n    // Prevent if already paid.\n    if (checkoutState?.checkout?.status === 'paid') return;\n    // Prevent multiple simultaneous payment attempts\n    if (this.confirming) return;\n\n    this.confirming = true;\n\n    try {\n      // must have a public_key and external_intent_id.\n      const { external_intent_id, processor_data, reusable } = checkoutState?.checkout?.payment_intent || {};\n      const { public_key, customer_id } = processor_data?.razorpay || {};\n      if (!external_intent_id || !public_key) {\n        createErrorNotice({ message: sprintf(__('Payment gateway configuration incomplete. Please ensure Razorpay is properly configured for transactions.', 'surecart')) });\n        return;\n      }\n\n      // Wait for script to load if not loaded yet.\n      if (!this.razorpayInstance) {\n        this.razorpayInstance = await loadRazorpay();\n      }\n\n      const customer = checkoutState?.checkout?.customer as Customer | undefined;\n      const prefill = customer\n        ? {\n            ...(customer.name && { name: customer.name }),\n            ...(customer.email && { email: customer.email }),\n            ...(customer.phone && { contact: customer.phone }),\n          }\n        : undefined;\n\n      /*\n       * Razorpay options.\n       * @see https://razorpay.com/docs/payments/payment-gateway/web-integration/standard/integration-steps/#123-checkout-options\n       */\n      let options = {\n        key: public_key,\n        order_id: external_intent_id,\n        prefill,\n        customer_id,\n        recurring: reusable,\n        handler: (response: any) => {\n          if (response?.razorpay_payment_id) {\n            return updateFormState('PAID');\n          } else {\n            createErrorNotice({ message: __('Payment verification failed. Please contact support.', 'surecart') });\n            updateFormState('REJECT');\n          }\n        },\n        modal: {\n          ondismiss: () => {\n            updateFormState('REJECT');\n          },\n        },\n      };\n\n      if (window?.wp?.hooks?.applyFilters) {\n        options = window.wp.hooks.applyFilters('surecart_razorpay_checkout_options', options);\n      }\n\n      const razorpay = new this.razorpayInstance(options);\n\n      razorpay.on('payment.failed', response => {\n        createErrorNotice({\n          message: response?.error?.description || __('Payment failed. Please try again.', 'surecart'),\n        });\n        updateFormState('REJECT');\n        console.error('payment.failed', response);\n      });\n\n      razorpay.open();\n    } catch (err) {\n      createErrorNotice(err);\n      console.error(err);\n      updateFormState('REJECT');\n    } finally {\n      this.confirming = false;\n    }\n  }\n}\n"]}