import{Fragment,h}from"@stencil/core";import{sprintf,__}from"@wordpress/i18n";import{addQueryArgs}from"@wordpress/url";import apiFetch from"../../../../functions/fetch";import{onFirstVisible}from"../../../../functions/lazy";import{productNameWithPrice}from"../../../../functions/price";export class ScSubscription{constructor(){this.subscriptionId=void 0,this.showCancel=void 0,this.heading=void 0,this.query=void 0,this.protocol=void 0,this.subscription=void 0,this.updatePaymentMethodUrl=void 0,this.loading=void 0,this.cancelModal=void 0,this.resubscribeModal=void 0,this.busy=void 0,this.error=void 0}componentWillLoad(){onFirstVisible(this.el,(()=>{this.subscription||this.getSubscription()}))}async cancelPendingUpdate(){var e;if(confirm(__("Are you sure you want to cancel the pending update to your plan?","surecart")))try{this.busy=!0,this.subscription=await apiFetch({path:addQueryArgs(`surecart/v1/subscriptions/${null===(e=this.subscription)||void 0===e?void 0:e.id}/`,{expand:["price","price.product","current_period","period.checkout","purchase","purchase.license","license.activations","discount","discount.coupon"]}),method:"PATCH",data:{purge_pending_update:!0}})}catch(e){(null==e?void 0:e.message)?this.error=e.message:this.error=__("Something went wrong","surecart"),console.error(this.error)}finally{this.busy=!1}}async renewSubscription(){var e;try{this.error="",this.busy=!0,this.subscription=await apiFetch({path:addQueryArgs(`surecart/v1/subscriptions/${null===(e=this.subscription)||void 0===e?void 0:e.id}/renew`,{expand:["price","price.product","current_period","period.checkout","purchase","purchase.license","license.activations","discount","discount.coupon"]}),method:"PATCH"})}catch(e){this.error=(null==e?void 0:e.message)||__("Something went wrong","surecart")}finally{this.busy=!1}}async getSubscription(){var e;try{this.loading=!0,this.subscription=await await apiFetch({path:addQueryArgs(`surecart/v1/subscriptions/${this.subscriptionId||(null===(e=this.subscription)||void 0===e?void 0:e.id)}`,{expand:["price","price.product","current_period"],...this.query||{}})})}catch(e){(null==e?void 0:e.message)?this.error=e.message:this.error=__("Something went wrong","surecart"),console.error(this.error)}finally{this.loading=!1}}renderName(e){var t;return"string"!=typeof(null===(t=null==e?void 0:e.price)||void 0===t?void 0:t.product)?productNameWithPrice(null==e?void 0:e.price):__("Subscription","surecart")}renderRenewalText(e){const t=h("sc-subscription-status-badge",{subscription:e});return(null==e?void 0:e.cancel_at_period_end)&&e.current_period_end_at?h("span",null,t," ",
/* translators: %s: current period end date */
sprintf(__("Your plan will be canceled on %s","surecart"),e.current_period_end_at_date)):"trialing"===e.status&&e.trial_end_at?h("span",null,t," ",
/* translators: %s: trial end date */
sprintf(__("Your plan begins on %s","surecart"),e.trial_end_at_date)):"active"===e.status&&e.current_period_end_at?h("span",null,t," ",
/* translators: %s: current period end date */
sprintf(__("Your plan renews on %s","surecart"),e.current_period_end_at_date)):t}renderEmpty(){return h("slot",{name:"empty"},__("This subscription does not exist.","surecart"))}renderLoading(){return h("sc-stacked-list-row",{style:{"--columns":"2"},"mobile-size":0},h("div",{style:{padding:"0.5em"}},h("sc-skeleton",{style:{width:"30%",marginBottom:"0.75em"}}),h("sc-skeleton",{style:{width:"20%",marginBottom:"0.75em"}}),h("sc-skeleton",{style:{width:"40%"}})))}renderContent(){return this.loading?this.renderLoading():this.subscription?h(Fragment,null,h("sc-subscription-next-payment",{subscription:this.subscription,updatePaymentMethodUrl:this.updatePaymentMethodUrl},h("sc-subscription-details",{subscription:this.subscription}))):this.renderEmpty()}render(){var e,t,i,s,r,o,n;const c=(null==this?void 0:this.subscription.payment_method)||(null==this?void 0:this.subscription.manual_payment);return h("sc-dashboard-module",{key:"b56af72f03eb7e7f2e5fb13fc4d4c0abfb2b816e",heading:this.heading||__("Current Plan","surecart"),class:"subscription",error:this.error},!!this.subscription&&h("sc-flex",{key:"6809fa5df727602c589ef80f73756a2dbab2b7a9",slot:"end",class:"subscription__action-buttons"},this.updatePaymentMethodUrl&&c&&h("sc-button",{key:"120ab7e4fb77dfa7cad56184b994de93630063fb",type:"link",href:this.updatePaymentMethodUrl},h("sc-icon",{key:"b99478fb48eecd68c16458eee3b695e8136ff8a0",name:"credit-card",slot:"prefix"}),__("Update Payment Method","surecart")),!c&&h("sc-button",{key:"cce31dad789444ed69c58cefe78a2e1f7534e6a6",type:"link",href:addQueryArgs(window.location.href,{action:"create",model:"payment_method",id:null==this?void 0:this.subscription.id,...!1===(null===(e=null==this?void 0:this.subscription)||void 0===e?void 0:e.live_mode)?{live_mode:!1}:{}})},h("sc-icon",{key:"9e45bf37b36279481687490f6f311f87e0f440db",name:"credit-card",slot:"prefix"}),__("Add Payment Method","surecart")),!!Object.keys(null===(t=this.subscription)||void 0===t?void 0:t.pending_update).length&&h("sc-button",{key:"caa033fc2eaa1f3df333522d8958f7f5c89fc2a6",type:"link",onClick:()=>this.cancelPendingUpdate()},h("sc-icon",{key:"8c21f070dd97d15681a9c22e66b2016dc7b7fa92",name:"x-octagon",slot:"prefix"}),__("Cancel Scheduled Update","surecart")),(null===(i=null==this?void 0:this.subscription)||void 0===i?void 0:i.cancel_at_period_end)?h("sc-button",{type:"link",onClick:()=>this.renewSubscription()},h("sc-icon",{name:"repeat",slot:"prefix"}),__("Restore Plan","surecart")):"canceled"!==(null===(s=this.subscription)||void 0===s?void 0:s.status)&&(null===(r=this.subscription)||void 0===r?void 0:r.current_period_end_at)&&this.showCancel&&h("sc-button",{type:"link",onClick:()=>this.cancelModal=!0},h("sc-icon",{name:"x",slot:"prefix"}),__("Cancel Plan","surecart")),"canceled"===(null===(o=this.subscription)||void 0===o?void 0:o.status)&&h("sc-button",{key:"d5148a295b4bff31ad0c2aa89a830b62751bdbe9",type:"link",...(null===(n=this.subscription)||void 0===n?void 0:n.payment_method)||(null==this?void 0:this.subscription.manual_payment)?{onClick:()=>this.resubscribeModal=!0}:{href:null==this?void 0:this.updatePaymentMethodUrl}},h("sc-icon",{key:"4be25f5cff578c3bd6e86d908a3b7cd6993bed4f",name:"repeat",slot:"prefix"}),__("Resubscribe","surecart"))),h("sc-card",{key:"a3eb0a7da52e5930a25d4eb8b097f6259c9e1b3d",style:{"--overflow":"hidden"},noPadding:!0},this.renderContent()),this.busy&&h("sc-block-ui",{key:"0ccce48e183a25b6f0c7a2e6054eed5f373a57b1",spinner:!0}),h("sc-cancel-dialog",{key:"b5253bb0d32395daad69fe8e5f6607f36812f714",subscription:this.subscription,protocol:this.protocol,open:this.cancelModal,onScRequestClose:()=>this.cancelModal=!1,onScRefresh:()=>this.getSubscription()}),h("sc-subscription-reactivate",{key:"1a2d14f0a3238b45f9a0fbd9fe8ef9345491ecb7",subscription:this.subscription,open:this.resubscribeModal,onScRequestClose:()=>this.resubscribeModal=!1,onScRefresh:()=>this.getSubscription()}))}static get is(){return"sc-subscription"}static get encapsulation(){return"shadow"}static get originalStyleUrls(){return{$:["sc-subscription.scss"]}}static get styleUrls(){return{$:["sc-subscription.css"]}}static get properties(){return{subscriptionId:{type:"string",mutable:!1,complexType:{original:"string",resolved:"string",references:{}},required:!1,optional:!1,docs:{tags:[],text:"The subscription ID"},attribute:"subscription-id",reflect:!1},showCancel:{type:"boolean",mutable:!1,complexType:{original:"boolean",resolved:"boolean",references:{}},required:!1,optional:!1,docs:{tags:[],text:"Whether to show the cancel button"},attribute:"show-cancel",reflect:!1},heading:{type:"string",mutable:!1,complexType:{original:"string",resolved:"string",references:{}},required:!1,optional:!1,docs:{tags:[],text:"Heading to display"},attribute:"heading",reflect:!1},query:{type:"unknown",mutable:!1,complexType:{original:"object",resolved:"object",references:{}},required:!1,optional:!1,docs:{tags:[],text:"Query to pass to the API"}},protocol:{type:"unknown",mutable:!1,complexType:{original:"SubscriptionProtocol",resolved:"SubscriptionProtocol",references:{SubscriptionProtocol:{location:"import",path:"../../../../types",id:"src/types.ts::SubscriptionProtocol"}}},required:!1,optional:!1,docs:{tags:[],text:"The subscription protocol"}},subscription:{type:"unknown",mutable:!0,complexType:{original:"Subscription",resolved:"Subscription",references:{Subscription:{location:"import",path:"../../../../types",id:"src/types.ts::Subscription"}}},required:!1,optional:!1,docs:{tags:[],text:"The subscription"}},updatePaymentMethodUrl:{type:"string",mutable:!1,complexType:{original:"string",resolved:"string",references:{}},required:!1,optional:!1,docs:{tags:[],text:"Update the payment method url"},attribute:"update-payment-method-url",reflect:!1}}}static get states(){return{loading:{},cancelModal:{},resubscribeModal:{},busy:{},error:{}}}static get elementRef(){return"el"}}