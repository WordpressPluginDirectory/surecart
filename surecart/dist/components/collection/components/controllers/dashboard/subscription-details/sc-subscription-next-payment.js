import{Fragment,h,Host}from"@stencil/core";import{__}from"@wordpress/i18n";import{addQueryArgs}from"@wordpress/url";import apiFetch from"../../../../functions/fetch";import{formatTaxDisplay}from"../../../../functions/tax";export class ScSubscriptionNextPayment{constructor(){this.subscription=void 0,this.updatePaymentMethodUrl=void 0,this.period=void 0,this.loading=!0,this.error=void 0,this.details=void 0}componentWillLoad(){this.fetch()}handleSubscriptionChange(){this.fetch()}async fetch(){var i,t,e;if((null===(i=this.subscription)||void 0===i?void 0:i.cancel_at_period_end)&&this.subscription.current_period_end_at)this.loading=!1;else if("canceled"!==(null===(t=this.subscription)||void 0===t?void 0:t.status))try{this.loading=!0,this.period=await apiFetch({method:"PATCH",path:addQueryArgs(`surecart/v1/subscriptions/${null===(e=this.subscription)||void 0===e?void 0:e.id}/upcoming_period`,{skip_product_group_validation:!0,expand:["period.checkout","checkout.line_items","checkout.checkout_fees","checkout.shipping_fees","checkout.payment_method","checkout.manual_payment_method","payment_method.card","payment_method.payment_instrument","payment_method.paypal_account","payment_method.bank_account","line_item.price","line_item.fees","price.product","period.subscription"]}),data:{purge_pending_update:!1}})}catch(i){console.error(i),this.error=i}finally{this.loading=!1}else this.loading=!1}render(){var i,t,e,n,o,s,l;if(this.loading)return h("sc-toggle",{borderless:!0,disabled:!0},h("sc-flex",{slot:"summary",flexDirection:"column"},h("sc-skeleton",{style:{width:"200px"}}),h("sc-skeleton",{style:{width:"400px"}}),h("sc-skeleton",{style:{width:"300px"}})));const a=null===(i=null==this?void 0:this.period)||void 0===i?void 0:i.checkout;if(!a)return h("div",{style:{padding:"var(--sc-spacing-medium)"}},h("sc-subscription-details",{slot:"summary",subscription:this.subscription}));const r=(null==a?void 0:a.manual_payment)?null==a?void 0:a.manual_payment_method:null,d=(null==this?void 0:this.subscription.payment_method)||(null==this?void 0:this.subscription.manual_payment),p=null===(t=null==a?void 0:a.checkout_fees)||void 0===t?void 0:t.data,u=null===(e=null==a?void 0:a.shipping_fees)||void 0===e?void 0:e.data;return h(Host,null,h("sc-toggle",{borderless:!0,shady:!0},h("span",{slot:"summary"},h("sc-subscription-details",{subscription:this.subscription},h("div",{style:{fontSize:"var(--sc-font-size-small)"}},__("Your next payment is","surecart")," ",h("strong",null,null==a?void 0:a.amount_due_display_amount)," ",!!(null===(n=this.subscription)||void 0===n?void 0:n.remaining_period_text)&&`â€” ${null===(o=this.subscription)||void 0===o?void 0:o.remaining_period_text}`))),h("sc-card",{noPadding:!0,borderless:!0},null===(s=null==a?void 0:a.line_items)||void 0===s?void 0:s.data.map((i=>{var t,e,n,o,s,l,a,r;return h("sc-product-line-item",{image:null===(e=null===(t=i.price)||void 0===t?void 0:t.product)||void 0===e?void 0:e.line_item_image,name:null===(o=null===(n=i.price)||void 0===n?void 0:n.product)||void 0===o?void 0:o.name,price:null===(s=null==i?void 0:i.price)||void 0===s?void 0:s.name,variant:null==i?void 0:i.variant_display_options,editable:!1,removable:!1,note:null==i?void 0:i.display_note,scratchDisplayAmount:null==i?void 0:i.scratch_display_amount,displayAmount:null==i?void 0:i.subtotal_display_amount,quantity:null==i?void 0:i.quantity,amount:null==i?void 0:i.subtotal_display_amount,interval:`${null===(l=null==i?void 0:i.price)||void 0===l?void 0:l.short_interval_text} ${null===(a=null==i?void 0:i.price)||void 0===a?void 0:a.short_interval_count_text}`,purchasableStatus:null==i?void 0:i.purchasable_status_display,fees:null===(r=null==i?void 0:i.fees)||void 0===r?void 0:r.data})})),h("sc-line-item",null,h("span",{slot:"description"},__("Subtotal","surecart")),h("span",{slot:"price-description"},null==a?void 0:a.subtotal_display_amount)),!!a.proration_amount&&h("sc-line-item",null,h("span",{slot:"description"},__("Proration Credit","surecart")),h("span",{slot:"price-description"},null==a?void 0:a.proration_display_amount)),!!a.applied_balance_amount&&h("sc-line-item",null,h("span",{slot:"description"},__("Applied Balance","surecart")),h("span",{slot:"price-description"},null==a?void 0:a.applied_balance_display_amount)),(null==p?void 0:p.length)>0&&h(Fragment,null,null==p?void 0:p.map((i=>h("sc-line-item",null,h("span",{slot:"description"},null==i?void 0:i.description),h("span",{slot:"price"},null==i?void 0:i.display_amount))))),!!a.trial_amount&&h("sc-line-item",null,h("span",{slot:"description"},__("Trial","surecart")),h("span",{slot:"price-description"},null==a?void 0:a.trial_display_amount)),!!(null==a?void 0:a.discount_amount)&&h("sc-line-item",null,h("span",{slot:"description"},__("Discounts","surecart")),h("span",{slot:"price-description"},null==a?void 0:a.discounts_display_amount)),!!(null==a?void 0:a.shipping_amount)&&h(Fragment,null,h("sc-line-item",{style:{marginTop:"var(--sc-spacing-small)"}},h("span",{slot:"description"},__("Shipping","surecart")),h("span",{slot:"price-description"},null==a?void 0:a.shipping_display_amount)),(null==u?void 0:u.length)>0&&h(Fragment,null,null==u?void 0:u.map((i=>h("sc-line-item",null,h("span",{slot:"description"},null==i?void 0:i.description),h("span",{slot:"price"},null==i?void 0:i.display_amount)))))),!!a.tax_amount&&h("sc-line-item",null,h("span",{slot:"description"},formatTaxDisplay(null==a?void 0:a.tax_label)),h("span",{slot:"price-description"},null==a?void 0:a.tax_display_amount)),h("sc-divider",{style:{"--spacing":"0"}}),h("sc-line-item",null,h("span",{slot:"description"},__("Payment","surecart")),d&&h("a",{href:this.updatePaymentMethodUrl,slot:"price-description"},h("sc-flex",{"justify-content":"flex-start","align-items":"center",style:{"--spacing":"0.5em"}},r?h("sc-manual-payment-method",{paymentMethod:r}):h("sc-payment-method",{paymentMethod:null==a?void 0:a.payment_method}),h("sc-icon",{name:"edit-3"}))),!d&&h("a",{href:addQueryArgs(window.location.href,{action:"create",model:"payment_method",id:null==this?void 0:this.subscription.id,...!1===(null===(l=null==this?void 0:this.subscription)||void 0===l?void 0:l.live_mode)?{live_mode:!1}:{}}),slot:"price-description"},__("Add Payment Method","surecart"))),h("sc-line-item",{style:{"--price-size":"var(--sc-font-size-x-large)"}},h("span",{slot:"title"},__("Total Due","surecart")),h("span",{slot:"price"},null==a?void 0:a.amount_due_display_amount),h("span",{slot:"currency"},a.currency)))))}static get is(){return"sc-subscription-next-payment"}static get encapsulation(){return"shadow"}static get properties(){return{subscription:{type:"unknown",mutable:!1,complexType:{original:"Subscription",resolved:"Subscription",references:{Subscription:{location:"import",path:"../../../../types",id:"src/types.ts::Subscription"}}},required:!1,optional:!1,docs:{tags:[],text:""}},updatePaymentMethodUrl:{type:"string",mutable:!1,complexType:{original:"string",resolved:"string",references:{}},required:!1,optional:!1,docs:{tags:[],text:"Update the payment method url"},attribute:"update-payment-method-url",reflect:!1}}}static get states(){return{period:{},loading:{},error:{},details:{}}}static get watchers(){return[{propName:"subscription",methodName:"handleSubscriptionChange"}]}}