import{r as e,c as i,h as t,a as o}from"./p-e97fde0a.js";import{p as l}from"./p-9ef0f73f.js";import{s}from"./p-fab02ef6.js";import{o as d,s as n,u as a}from"./p-53e7f7d7.js";import{o as r}from"./p-95325ec5.js";import"./p-273a6ac5.js";import{s as c,g as u}from"./p-566c9487.js";import{c as v}from"./p-ff10bfbf.js";import{c as f}from"./p-1f60f497.js";import{b as p}from"./p-6b5d827f.js";import{a as m}from"./p-401e165e.js";import"./p-03631502.js";import"./p-9dbc54d6.js";import"./p-d3366af3.js";import"./p-830ab1a3.js";import"./p-ec182234.js";import"./p-3f6362a4.js";import"./p-4df6e0c5.js";import"./p-93127aa7.js";import"./p-30eb50ff.js";const h="sc-stripe-payment-element{display:block}sc-stripe-payment-element [hidden]{display:none}.loader{display:grid;height:128px;gap:2em}.loader__row{display:flex;align-items:flex-start;justify-content:space-between;gap:1em}.loader__details{display:grid;gap:0.5em}";const y=h;const b=class{constructor(t){e(this,t);this.scPaid=i(this,"scPaid",7);this.scSetState=i(this,"scSetState",7);this.scPaymentInfoAdded=i(this,"scPaymentInfoAdded",7);this.error=undefined;this.confirming=false;this.isInitializingStripe=false;this.isCreatingUpdatingStripeElement=false;this.loaded=false;this.styles=undefined}async componentWillLoad(){this.fetchStyles();this.syncCheckoutMode()}async handleStylesChange(){this.createOrUpdateElements()}async fetchStyles(){this.styles=await this.getComputedStyles()}getComputedStyles(){return new Promise((e=>{let i=setInterval((()=>{const t=window.getComputedStyle(document.body);const o=t.getPropertyValue("--sc-color-primary-500");if(o){clearInterval(i);e(t)}}),100)}))}async syncCheckoutMode(){d("checkout",(()=>{this.initializeStripe()}))}async componentDidLoad(){this.initializeStripe()}async initializeStripe(){var e,i;if(typeof((e=n===null||n===void 0?void 0:n.checkout)===null||e===void 0?void 0:e.live_mode)==="undefined"||((i=c===null||c===void 0?void 0:c.instances)===null||i===void 0?void 0:i.stripe)||this.isInitializingStripe){return}this.isInitializingStripe=true;const{processor_data:t}=u("stripe")||{};try{c.instances.stripe=await l.loadStripe(t===null||t===void 0?void 0:t.publishable_key,{stripeAccount:t===null||t===void 0?void 0:t.account_id});this.error=""}catch(e){this.error=(e===null||e===void 0?void 0:e.message)||wp.i18n.__("Stripe could not be loaded","surecart");this.isInitializingStripe=false;return}this.createOrUpdateElements();this.handleUpdateElement();this.unlistenToCheckout=d("checkout",(()=>{this.fetchStyles();this.createOrUpdateElements();this.handleUpdateElement()}));this.unlistenToFormState=r("formState",(()=>{var e;if(!((e=n===null||n===void 0?void 0:n.checkout)===null||e===void 0?void 0:e.payment_method_required))return;if("paying"===v()){this.maybeConfirmOrder()}}));this.isInitializingStripe=false}clearStripeInstances(){var e,i,t,o;this.isInitializingStripe=false;this.isCreatingUpdatingStripeElement=false;if(this===null||this===void 0?void 0:this.element){try{(i=(e=this.element)===null||e===void 0?void 0:e.unmount)===null||i===void 0?void 0:i.call(e)}catch(e){console.warn("Could not unmount Stripe element:",e)}this.element=null}if((t=c===null||c===void 0?void 0:c.instances)===null||t===void 0?void 0:t.stripeElements){c.instances.stripeElements=null}if((o=c===null||c===void 0?void 0:c.instances)===null||o===void 0?void 0:o.stripe){c.instances.stripe=null}}disconnectedCallback(){this.unlistenToFormState();this.unlistenToCheckout();this.clearStripeInstances()}getElementsConfig(){var e,i,t,o;const l=getComputedStyle(this.el);return{mode:((e=n.checkout)===null||e===void 0?void 0:e.remaining_amount_due)>0?"payment":"setup",amount:(i=n.checkout)===null||i===void 0?void 0:i.remaining_amount_due,currency:(t=n.checkout)===null||t===void 0?void 0:t.currency,setupFutureUsage:((o=n.checkout)===null||o===void 0?void 0:o.reusable_payment_method_required)?"off_session":null,appearance:{variables:{colorPrimary:l.getPropertyValue("--sc-color-primary-500")||"black",colorText:l.getPropertyValue("--sc-input-label-color")||"black",borderRadius:l.getPropertyValue("--sc-input-border-radius-medium")||"4px",colorBackground:l.getPropertyValue("--sc-input-background-color")||"white",fontSizeBase:l.getPropertyValue("--sc-input-font-size-medium")||"16px",colorLogo:l.getPropertyValue("--sc-stripe-color-logo")||"light",colorLogoTab:l.getPropertyValue("--sc-stripe-color-logo-tab")||"light",colorLogoTabSelected:l.getPropertyValue("--sc-stripe-color-logo-tab-selected")||"light",colorTextPlaceholder:l.getPropertyValue("--sc-input-placeholder-color")||"black"},rules:{".Input":{border:l.getPropertyValue("--sc-input-border")}}}}}maybeApplyFilters(e){var i,t,o;if(!((t=(i=window===null||window===void 0?void 0:window.wp)===null||i===void 0?void 0:i.hooks)===null||t===void 0?void 0:t.applyFilters))return e;return{...e,paymentMethodOrder:window.wp.hooks.applyFilters("surecart_stripe_payment_element_payment_method_order",[],n.checkout),wallets:window.wp.hooks.applyFilters("surecart_stripe_payment_element_wallets",{},n.checkout),terms:window.wp.hooks.applyFilters("surecart_stripe_payment_element_terms",{},n.checkout),fields:window.wp.hooks.applyFilters("surecart_stripe_payment_element_fields",(o=e.fields)!==null&&o!==void 0?o:{})}}createOrUpdateElements(){var e,i,t,o,l,s;if(!((e=n===null||n===void 0?void 0:n.checkout)===null||e===void 0?void 0:e.payment_method_required))return;if(!c.instances.stripe||this.isCreatingUpdatingStripeElement)return;if(((i=n.checkout)===null||i===void 0?void 0:i.status)&&["paid","processing"].includes((t=n.checkout)===null||t===void 0?void 0:t.status))return;this.isCreatingUpdatingStripeElement=true;if(!c.instances.stripeElements){c.instances.stripeElements=c.instances.stripe.elements(this.getElementsConfig());const{line1:e,line2:i,city:t,state:d,country:a,postal_code:r}=(o=p("shipping"))!==null&&o!==void 0?o:{};const u=this.maybeApplyFilters({defaultValues:{billingDetails:{name:(l=n.checkout)===null||l===void 0?void 0:l.name,email:(s=n.checkout)===null||s===void 0?void 0:s.email,...e&&{address:{line1:e,line2:i,city:t,state:d,country:a,postal_code:r}}}},fields:{billingDetails:{email:"never"}}});c.instances.stripeElements.create("payment",u).mount(this.container);this.element=c.instances.stripeElements.getElement("payment");this.element.on("ready",(()=>this.loaded=true));this.element.on("change",(e=>{var i,t,o,l,s,d,a;const r=["cashapp","klarna","clearpay"];n.paymentMethodRequiresShipping=r.includes((i=e===null||e===void 0?void 0:e.value)===null||i===void 0?void 0:i.type);if(e.complete){this.scPaymentInfoAdded.emit({checkout_id:(t=n.checkout)===null||t===void 0?void 0:t.id,currency:(o=n.checkout)===null||o===void 0?void 0:o.currency,processor_type:"stripe",total_amount:(l=n.checkout)===null||l===void 0?void 0:l.total_amount,line_items:(s=n.checkout)===null||s===void 0?void 0:s.line_items,payment_method:{billing_details:{email:(d=n.checkout)===null||d===void 0?void 0:d.email,name:(a=n.checkout)===null||a===void 0?void 0:a.name}}})}}));this.isCreatingUpdatingStripeElement=false;return}c.instances.stripeElements.update(this.getElementsConfig());this.isCreatingUpdatingStripeElement=false}handleUpdateElement(){var e,i;if(!this.element)return;if(((e=n.checkout)===null||e===void 0?void 0:e.status)!=="draft")return;const{name:t,email:o}=n.checkout;const{line_1:l,line_2:s,city:d,state:a,country:r,postal_code:c}=((i=n.checkout)===null||i===void 0?void 0:i.shipping_address)||{};const u=this.maybeApplyFilters({defaultValues:{billingDetails:{name:t,email:o,address:{line1:l,line2:s,city:d,state:a,country:r,postal_code:c}}},fields:{billingDetails:{email:"never"}}});this.element.update(u)}async submit(){if((s===null||s===void 0?void 0:s.id)!=="stripe")return;const{error:e}=await c.instances.stripeElements.submit();if(e){console.error({error:e});a("REJECT");f(e);this.error=e.message;return}}async maybeConfirmOrder(){var e,i,t,o,l,d,a,r,c,u,v,f,p,m;if((s===null||s===void 0?void 0:s.id)!=="stripe")return;if(((i=(e=n.checkout)===null||e===void 0?void 0:e.payment_intent)===null||i===void 0?void 0:i.processor_type)!=="stripe")return;if(!((d=(l=(o=(t=n.checkout)===null||t===void 0?void 0:t.payment_intent)===null||o===void 0?void 0:o.processor_data)===null||l===void 0?void 0:l.stripe)===null||d===void 0?void 0:d.type))return;if(!((u=(c=(r=(a=n.checkout)===null||a===void 0?void 0:a.payment_intent)===null||r===void 0?void 0:r.processor_data)===null||c===void 0?void 0:c.stripe)===null||u===void 0?void 0:u.client_secret))return;return await this.confirm((m=(p=(f=(v=n.checkout)===null||v===void 0?void 0:v.payment_intent)===null||f===void 0?void 0:f.processor_data)===null||p===void 0?void 0:p.stripe)===null||m===void 0?void 0:m.type)}async confirm(e,i={}){var t,o,l,s;const d={elements:c.instances.stripeElements,clientSecret:(s=(l=(o=(t=n.checkout)===null||t===void 0?void 0:t.payment_intent)===null||o===void 0?void 0:o.processor_data)===null||l===void 0?void 0:l.stripe)===null||s===void 0?void 0:s.client_secret,confirmParams:{return_url:m(window.location.href,{...n.checkout.id?{checkout_id:n.checkout.id}:{}}),payment_method_data:{billing_details:{email:n.checkout.email}}},redirect:"if_required",...i};if(this.confirming)return;if(!c.instances.stripe)return;try{this.scSetState.emit("PAYING");const i=e==="setup"?await c.instances.stripe.confirmSetup(d):await c.instances.stripe.confirmPayment(d);if(i===null||i===void 0?void 0:i.error){this.error=i.error.message;throw i.error}else{this.scSetState.emit("PAID");this.scPaid.emit()}}catch(e){console.error(e);a("REJECT");f(e);if(e.message){this.error=e.message}}finally{this.confirming=false}}render(){return t("div",{key:"ef1912d4329e262d332ebbb477a09e5c11b43b2e",class:"sc-stripe-payment-element","data-testid":"stripe-payment-element"},!!this.error&&t("sc-text",{key:"80b00ef6e7906a901ac947055b4a1f9fe671ed09",style:{color:"var(--sc-color-danger-500)","--font-size":"var(--sc-font-size-small)",marginBottom:"0.5em"}},this.error),t("div",{key:"1591ca86836e41cd864d4143a76425899611f530",class:"loader",hidden:this.loaded},t("div",{key:"5650bb938264e6ecd770f9b9c276b8414e8c9198",class:"loader__row"},t("div",{key:"7db67307a5071ac3bca4818e72cbc884f3f59e3b",style:{width:"50%"}},t("sc-skeleton",{key:"44457c13aea449f94f435f9f09aacc2d9e78af9c",style:{width:"50%",marginBottom:"0.5em"}}),t("sc-skeleton",{key:"9c2bfc8a16d93a2df8266a385a53e174d752c3e6"})),t("div",{key:"6d5247356d7f12dcd5010b2e7b230005b20f6941",style:{flex:"1"}},t("sc-skeleton",{key:"b6b59f8821a87a368bc7e2c9135587ff64c86f11",style:{width:"50%",marginBottom:"0.5em"}}),t("sc-skeleton",{key:"22e85f0a5d5e0beddebfc23f7361435808708bb6"})),t("div",{key:"9c04877dd36b33863adf59901eaee07b591090d2",style:{flex:"1"}},t("sc-skeleton",{key:"e9064ed24c4e44102d88d4c61f4fed2c28f6f49c",style:{width:"50%",marginBottom:"0.5em"}}),t("sc-skeleton",{key:"ad1546eadec3c7e67440336bbe2571168bd0e77f"}))),t("div",{key:"bd321994c74a0840efb7264d1a99017547a0da23",class:"loader__details"},t("sc-skeleton",{key:"ff07c55e382d0f43e585fc82b81b48457102189f",style:{height:"1rem"}}),t("sc-skeleton",{key:"07ffc2a4219091a02ba9cd53d7f496adb88e99ac",style:{height:"1rem",width:"30%"}}))),t("div",{key:"e866dfe42c0ae9c6b6b0f96b72f79b2c154025d4",hidden:!this.loaded,class:"sc-payment-element-container",ref:e=>this.container=e}))}get el(){return o(this)}static get watchers(){return{styles:["handleStylesChange"]}}};b.style=y;export{b as sc_stripe_payment_element};
//# sourceMappingURL=p-398770e0.entry.js.map